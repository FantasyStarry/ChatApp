<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Authentication Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin: 10px 0; }
        input[type="text"] { width: 300px; margin: 5px; }
        button { margin: 5px; padding: 5px 10px; }
        .auth-message { color: green; font-weight: bold; }
        .error-message { color: red; font-weight: bold; }
        .regular-message { color: blue; }
    </style>
</head>
<body>
    <h1>WebSocket Authentication Test</h1>
    
    <div>
        <label>Server URL:</label>
        <input type="text" id="serverUrl" value="ws://localhost:8080/api/ws/1" />
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
    </div>
    
    <div>
        <label>JWT Token:</label>
        <input type="text" id="token" placeholder="Your JWT token here" />
        <input type="text" id="chatroomId" value="1" placeholder="Chatroom ID" />
        <button onclick="authenticate()">Authenticate</button>
    </div>
    
    <div>
        <label>Message:</label>
        <input type="text" id="messageInput" placeholder="Type your message here" />
        <button onclick="sendMessage()">Send Message</button>
    </div>
    
    <div id="messages"></div>
    
    <script>
        let ws = null;
        let isAuthenticated = false;
        
        function connect() {
            const url = document.getElementById('serverUrl').value;
            ws = new WebSocket(url);
            
            ws.onopen = function(event) {
                addMessage('Connected to WebSocket server', 'auth-message');
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.type === 'auth_success') {
                    isAuthenticated = true;
                    addMessage('Authentication successful!', 'auth-message');
                } else if (data.type === 'message') {
                    addMessage(`[${data.username}]: ${data.content}`, 'regular-message');
                } else {
                    addMessage(`Received: ${event.data}`, 'regular-message');
                }
            };
            
            ws.onclose = function(event) {
                isAuthenticated = false;
                addMessage('Connection closed', 'error-message');
            };
            
            ws.onerror = function(error) {
                addMessage('WebSocket error: ' + error, 'error-message');
            };
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
                isAuthenticated = false;
            }
        }
        
        function authenticate() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addMessage('Please connect to WebSocket first', 'error-message');
                return;
            }
            
            const token = document.getElementById('token').value;
            const chatroomId = parseInt(document.getElementById('chatroomId').value);
            
            if (!token) {
                addMessage('Please enter a JWT token', 'error-message');
                return;
            }
            
            const authMessage = {
                type: 'auth',
                token: token,
                chatroomId: chatroomId
            };
            
            ws.send(JSON.stringify(authMessage));
            addMessage('Sent authentication message', 'auth-message');
        }
        
        function sendMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addMessage('Please connect to WebSocket first', 'error-message');
                return;
            }
            
            if (!isAuthenticated) {
                addMessage('Please authenticate first', 'error-message');
                return;
            }
            
            const content = document.getElementById('messageInput').value;
            if (!content) {
                addMessage('Please enter a message', 'error-message');
                return;
            }
            
            const message = {
                type: 'message',
                content: content
            };
            
            ws.send(JSON.stringify(message));
            document.getElementById('messageInput').value = '';
        }
        
        function addMessage(message, className) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = className;
            messageDiv.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // Allow sending messages with Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>